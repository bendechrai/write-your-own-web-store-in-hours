# Write Your Own Web Store In Hours

![spacer](workshop-assets/readme-images/spacer.png)

## Connecting Auth0 and Stripe

> ‚ùó ‚ùó READ THIS ‚ùó ‚ùó
>
> This is arguably the crux of the entire workshop. Adding Auth0 to a React app is straight forward, and nothing overly complex has happened in Stripe.
>
> Normally, you'd probably create a database to link Auth0 users to Stripe customer IDs. But we're not going to do that.
>
> Instead, we're going to get Auth0 to talk directly to Stripe in order to make sure that every user has a customer ID, and then we'll return that ID to the application via the Access token which will be used by our lambda functions.
>
> üí™ LET'S GET TO IT! üí™

![spacer](workshop-assets/readme-images/spacer.png)

## Create an Auth0 Action

Actions are one of the extensibility features of Auth0, that allow you to run your own arbitrary JavaScript code when certain events are triggered. We're going to create an Action that will create a new Customer record in your Stripe tenant, and associate it with the currently logged in user.

![spacer](workshop-assets/readme-images/spacer.png)

üëâüíªüëà In the Auth0 Dashboard, head to [Actions > Library](https://manage.auth0.com/#/actions/library) in the left menu. From there, click "Build Custom".

Have a quick look at the Triggers. There's one for post-registration, that sounds like a good place for this. After a user registers, run our action.

However, for two main reasons, we're going to use the "Post Login" trigger. Firstly, we have a user already that hasn't had this action run against them. We want to make sure their user profile is still augmented.

Secondly, and similarly, if something goes wrong and we can't connect to Stripe, the process could fail. Using the Post Login trigger means a user can log out and back in to try again.

![spacer](workshop-assets/readme-images/spacer.png)

üëâüíªüëà Name the Action (e.g. "Link User to Stripe") and make sure Post Login is selected

> üì∑ **_The Auth0 Action Creation modal_**
>
> ![The Auth0 Action Creation modal](workshop-assets/readme-images/auth0-create-action.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

## Install the Stripe SDK

üëâüíªüëà Did you know that you can install almost any NPM module for use in Actions? Pretty sweet. Let's install the Stripe SDK within the Actions interface:

> üì∑ **_Installing Modules for Actions_**
>
> ![Installing Modules for Actions](workshop-assets/readme-images/auth0-actions-install-module.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

## Securely Store the Stripe Secret

üëâüíªüëà Grab that Stripe Secret Key from your `.env` file, and store it securely in your Auth0 dashboard using the Secrets Management area in Actions.

> üì∑ **_Setting Secrets for Actions_**
>
> ![Setting Secrets for Actions](workshop-assets/readme-images/auth0-actions-set-secret.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

## Write the code to link the user to Stripe

üëâüíªüëà Replace the empty `onExecutePostLogin` method with this, and click the "Deploy" button.

```javascript
exports.onExecutePostLogin = async (event, api) => {
  const stripe = require("stripe")(event.secrets.STRIPE_SECRET_KEY);

  // Do nothing if the Stripe Customer ID is set on this user already
  if (event.user.app_metadata.stripe_customer_id) {
    return;
  }

  // Create a new Stripe Customer ID
  const customer = await stripe.customers.create({
    email: event.user.email,
    description: "Automatically generated by an Auth0 Action",
    metadata: {
      auth0_user_id: event.user.user_id,
    },
  });

  // Save the Customer ID in the Auth0 user's app_metadata
  api.user.setAppMetadata("stripe_customer_id", customer.id);
};
```

The code has now been deployed, but needs to be added to the Action Flow...

![spacer](workshop-assets/readme-images/spacer.png)

## Add our new action into a flow

üëâüíªüëà In the left menu, navigate to [Actions > Flows](https://manage.auth0.com/#/actions/flows), and select the "Login" flow. On the right hand side, switch to the list of "Custom" Actions, and drag it into the flow visualiser in the centre of the page. Click the "Apply" button.

> üì∑ **_Adding an Auth0 Action to a Flow_**
>
> ![Adding an Auth0 Action to a Flow](workshop-assets/readme-images/auth0-actions-flow-editor.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

üëâüíªüëà Now log out and back in, and you'll be able to see a [new customer in the Stripe dashboard](https://dashboard.stripe.com/test/customers).

> üì∑ **_The new Stripe Customer_**
>
> ![The new Stripe Customer](workshop-assets/readme-images/stripe-new-customer.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

And if you drill into the new Stripe Customer and the Auth0 User, you'll see the linking data is all present and correct.

> üì∑ **_Comparing the Stripe Customer and Auth0 User_**
>
> ![Comparing the Stripe Customer and Auth0 User](workshop-assets/readme-images/user-customer-comparison.jpg)

![spacer](workshop-assets/readme-images/spacer.png)

---

[‚ñ∂Ô∏è STEP 8: Augmenting Access Tokens](./STEP-8-AUGMENTING-THE-ACCESS-TOKENSTARTING-A-STRIPE-CHECKOUT.md)

_[‚éå Back to step 6: Authenticating users](./STEP-6-AUTHENTICATING-USERS.md)_
